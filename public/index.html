<!DOCTYPE HTML>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>OHOL Map</title>
  <link href="leaflet.css" rel="stylesheet" />
  <script type="text/javascript" src="leaflet.js"></script>
  <link href="L.SimpleGraticule.css" rel="stylesheet" />
  <script type="text/javascript" src="L.SimpleGraticule.js"></script>
  <style>
body {
  background: white;
  color: black;
  width: 100%;
  height: 100%;
  position: absolute;
  overflow: hidden;
  margin: 0;
}

#map {
  width: 100%;
  height: 100%;
}

.birth {
  background-color: red;
  opacity: 0.5;
}
img {
  image-rendering: optimizeSpeed;             /*                     */
  image-rendering: -moz-crisp-edges;          /* Firefox             */
  image-rendering: -o-crisp-edges;            /* Opera               */
  image-rendering: -webkit-optimize-contrast; /* Chrome (and Safari) */
  image-rendering: optimize-contrast;         /* CSS3 Proposed       */
  -ms-interpolation-mode: nearest-neighbor;   /* IE8+                */
  }
  </style>
</head>

<body>
  <div id='map'></div>
</body>

<script type="text/javascript">
  var scale = Math.pow(2, 24)
  var crs = L.extend({}, L.CRS.Simple, {
    transformation: new L.transformation(1/scale, 0.5/scale, -1/scale, -0.5/scale)
  })
  var map = L.map('map', {
    crs: crs,
    maxBounds: [[-2147483648, -2147483648], [2147483647, 2147483647]],
    minZoom: 2,
    maxZoom: 24,
  })

  var tiles = L.tileLayer('tiles/{z}/{x}/{y}.png', {
    errorTileUrl: 'ground_U.png',
    minZoom: 2,
    maxZoom: 24,
    //minNativeZoom: 24,
    maxNativeZoom: 22,
    //zoomReverse: true, // tied to maxZoom, not maxNativeZoom
    attribution: '<a href="https://onehouronelife.com">Jason Rohrer</a> wondible',
  }).addTo(map);
  map.setView([0,0], 17)

  var serverlist = [
    'bigserver1',
    'bigserver2',
    'server1',
    'server2',
    'server3',
    'server4',
    'server5',
    'server6',
    'server7',
    'server8',
    'server9',
    'server10',
    'server11',
    'server12',
    'server13',
    'server14',
    'server15',
    ]

  var icon = L.divIcon({className: 'birth'});
  var overlays = {graticule: null}

  serverlist.forEach(function(server) {
    title = server + ' Monuments'
    overlays[title] = L.layerGroup();
    fetch("data/" + server + ".onehouronelife.com_monuments.json").then(function(response) {
      response.json().then(function(data){
        title = server + ' Monuments'
        data.forEach(function(point) {
          L.marker([point[1], point[0]]).bindPopup(point[2]).addTo(overlays[title])
          //L.circle([point[1], point[0]], {radius: 21000, fill: false}).addTo(overlays[title])
        })
        if (server == 'bigserver2') {
          overlays[title].addTo(map);
          var last = data[data.length-1]
          map.setView([last[1], last[0]], 17)
          }
      })
    })
  })


  /*
  fetch("data/bigserver2_points.json").then(function(response) {
    response.json().then(function(data){
      console.log(data.slice(0,100))
      data.forEach(function(point) {
        L.marker([point[1], point[0]], {icon: icon}).bindPopup(point[2]).addTo(map)
        //L.marker([point[1], point[0]]).bindPopup(point[2]).addTo(map)
      })
    })
  })
  */

  //L.marker([0,0], {icon: icon}).addTo(map)

  var options = {
    showOriginLabel: false,
    redraw: 'move',
    attribution: '<a href="https://github.com/ablakey/Leaflet.SimpleGraticule">ablakey/SimpleGraticle</a>',
    zoomIntervals: [
      {start: 0,  end: 3,  interval: 1000000000},
      {start: 4,  end: 6,  interval: 100000000},
      {start: 7,  end: 9,  interval: 10000000},
      {start: 10, end: 13, interval: 1000000},
      {start: 14, end: 16, interval: 100000},
      {start: 17, end: 19, interval: 10000},
      {start: 20, end: 23, interval: 1000},
      {start: 24, end: 29, interval: 40},
    ]
  };

  var graticule = L.simpleGraticule(options)
  overlays['graticule'] = graticule

  L.control.layers({}, overlays).addTo(map);

  L.Control.Scale.include({
    _updateMetric: function (maxMeters) {
      var meters = this._getRoundNum(maxMeters);
      var label = meters;
      if (meters < 1000) {
        label = meters;
      } else if (meters < 1000000) {
        label = (meters / 1000) + 'K';
      } else if (meters < 1000000000) {
        label = (meters / 1000000) + 'M';
      } else {
        label = (meters / 1000000000) + 'G';
      }

      label = label + ' z' + this._map.getZoom();

      this._updateScale(this._mScale, label, meters / maxMeters);
    }
  })
  L.control.scale({imperial: false}).addTo(map);

</script>
</html>

